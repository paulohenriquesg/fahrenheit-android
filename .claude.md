# Fahrenheit Android - Project Guidelines

## DTO Consolidation Pattern

When working with API responses that return similar data in different formats (minified, detailed, search results), follow these guidelines:

### 1. Extend Existing DTOs
**DON'T** create new DTO files for variations. **DO** add nullable fields to existing DTOs.

```kotlin
// ❌ DON'T create separate DTOs
data class Author(val id: String, val name: String)
data class SearchAuthor(val id: String, val name: String, val numBooks: Int)

// ✅ DO extend with nullable fields
data class Author(
    val id: String,
    val name: String,
    val numBooks: Int? = null  // Only present in search responses
)
```

### 2. Use @SerializedName for All API Response Formats
Ensure Gson can deserialize from all API response variations:

```kotlin
data class ItemMetadata(
    // Detailed API responses (array format)
    @SerializedName("authors") val authors: List<Author>? = null,
    @SerializedName("narrators") val narrators: List<String>? = null,

    // Minified API responses (string format)
    @SerializedName("authorName") val authorName: String? = null,
    @SerializedName("narratorName") val narratorName: String? = null
)
```

### 3. Add Helper Extensions for Dual-Format Handling
Create extension functions to abstract format differences:

```kotlin
fun ItemMetadata.getAuthorsDisplay(): String =
    authors?.joinToString(", ") { it.name } ?: authorName.orEmpty()

fun ItemMetadata.getNarratorsDisplay(): String =
    narrators?.joinToString(", ") ?: narratorName.orEmpty()

// Usage in UI code
val authorText = metadata.getAuthorsDisplay()  // Works for both formats
```

### 4. Delete Duplicate DTOs Only After Migration
Ensure all consumer code is updated before removing old DTOs:

1. Extend base DTO with new nullable fields
2. Update consumer code to use extended DTO
3. Test thoroughly
4. Delete old duplicate DTO
5. Remove unused imports

### 5. Prioritize Code Reuse Over Creating New Files
Before creating a new model file, check if existing DTOs can be extended.

**Decision Tree:**
- Same entity, different fields? → Extend with nullable fields
- Same structure, different context? → Reuse existing DTO
- Completely new entity? → Create new DTO file

## Type Conversion Guidelines

### Float vs Double
When consolidating DTOs with numeric type differences:
- **Always use Double** - Gson auto-converts Float → Double safely
- Update consumer code to use Double consistently
- No data loss in conversion

```kotlin
// Before consolidation
data class MediaProgressResponse(val duration: Float)
data class MediaProgress(val duration: Double)

// After consolidation
data class MediaProgressResponse(val duration: Double)  // Accepts both Float and Double from API
```

### Nullable vs Non-Nullable
Use nullable fields when:
- Field is not present in all API response variations
- Field is optional in API specification
- Field may be null in some contexts

## Testing Consolidated DTOs

Always test deserialization from all response formats:

```kotlin
@Test
fun `DTO handles minified response`() {
    val json = """{"authorName": "John Doe"}"""
    val metadata = Gson().fromJson(json, ItemMetadata::class.java)
    assertEquals("John Doe", metadata.getAuthorsDisplay())
}

@Test
fun `DTO handles detailed response`() {
    val json = """{"authors": [{"name": "John Doe"}]}"""
    val metadata = Gson().fromJson(json, ItemMetadata::class.java)
    assertEquals("John Doe", metadata.getAuthorsDisplay())
}
```

## Checking API Responses

### Method 1: Using ADB Logcat
The app has extensive logging enabled via `HttpLoggingInterceptor.Level.BODY` in `ApiClient.kt`. To view API responses:

```bash
# Clear logs and capture new ones
adb logcat -c

# Navigate in the app to trigger API calls

# View OkHttp logs (API requests/responses)
adb logcat -d | grep -A 50 "OkHttpClient\|okhttp3"

# View custom logs for shelves
adb logcat -d | grep -E "ShelfDeserializer|MainScreen"

# View all recent logs
adb logcat -d -t 200
```

### Method 2: Adding Debug Logging
Add logging in relevant files to see specific data:

**ShelfDeserializer.kt** - See what shelf types are being processed:
```kotlin
Log.d("ShelfDeserializer", "Processing shelf - Type: $type, Label: $label, Total: $total")
Log.d("ShelfDeserializer", "Full JSON: $jsonObject")
```

**MainScreen.kt** - See what shelves are received:
```kotlin
fetchPersonalizedView(libraryId) { shelves ->
    Log.d("MainScreen", "Received ${shelves.size} shelves")
    shelves.forEachIndexed { index, shelf ->
        Log.d("MainScreen", "Shelf $index: type=${shelf.type}, label=${shelf.label}")
    }
}
```

### Direct API Access

#### Creating a Debug Utility
Create a simple test file to make direct API calls:

**File: `app/src/test/java/com/paulohenriquesg/fahrenheit/api/ApiDebugUtil.kt`**
```kotlin
package com.paulohenriquesg.fahrenheit.api

import com.google.gson.GsonBuilder
import okhttp3.OkHttpClient
import okhttp3.Request
import okhttp3.logging.HttpLoggingInterceptor
import retrofit2.Retrofit
import retrofit2.converter.gson.GsonConverterFactory

object ApiDebugUtil {
    fun createApiService(host: String, token: String): ApiService {
        val logging = HttpLoggingInterceptor().apply {
            setLevel(HttpLoggingInterceptor.Level.BODY)
        }

        val client = OkHttpClient.Builder()
            .addInterceptor(logging)
            .addInterceptor { chain ->
                val request = chain.request().newBuilder()
                    .addHeader("Authorization", "Bearer $token")
                    .addHeader("Content-Type", "application/json")
                    .build()
                chain.proceed(request)
            }
            .build()

        val gson = GsonBuilder()
            .registerTypeAdapter(Shelf::class.java, ShelfDeserializer())
            .setPrettyPrinting()
            .create()

        return Retrofit.Builder()
            .baseUrl(host)
            .client(client)
            .addConverterFactory(GsonConverterFactory.create(gson))
            .build()
            .create(ApiService::class.java)
    }

    @JvmStatic
    fun main(args: Array<String>) {
        if (args.size < 3) {
            println("Usage: ApiDebugUtil <host> <token> <libraryId>")
            return
        }

        val host = args[0]
        val token = args[1]
        val libraryId = args[2]

        val api = createApiService(host, token)
        val response = api.getPersonalizedView(libraryId).execute()

        if (response.isSuccessful) {
            println("\n=== Personalized View Response ===")
            response.body()?.forEach { shelf ->
                println("\nShelf: ${shelf.label}")
                println("  Type: ${shelf.type}")
                println("  ID: ${shelf.id}")
                println("  Total: ${shelf.total}")
                println("  Entities: ${shelf.bookEntities?.size ?: shelf.authorEntities?.size ?: shelf.seriesEntities?.size ?: 0}")
            }
        } else {
            println("Error: ${response.code()} - ${response.message()}")
        }
    }
}
```

#### Usage
```bash
# Run the utility (need to provide host, token, and libraryId)
./gradlew :app:test --tests ApiDebugUtil --args="https://your-server.com YOUR_TOKEN library-id"
```

### Credentials Location
- Credentials are stored encrypted in `EncryptedSharedPreferences`
- File: `/data/data/com.paulohenriquesg.fahrenheit/shared_prefs/encrypted_app_prefs.xml`
- Cannot be read directly due to encryption
- Use logcat with OkHttp logging to see Authorization headers and make direct curl calls

## Commit Message Format

**ALWAYS use one-line commit messages without attribution.**

- Keep messages concise and descriptive
- No multi-line explanations
- No "Co-Authored-By" or attribution lines
- No emoji or special formatting

Examples:
```
Consolidate Author DTOs to support search and detailed responses
Improve dark mode button visibility and add purple styling for disabled buttons
Fix crash when opening book details from home screen
```

---

## Current DTO Consolidation Status

### Completed
- (Track progress here as refactoring proceeds)

### In Progress
- Phase 0: Project memory creation ✓

### Pending
- Phase 1-9: See implementation plan in `.claude-personal/plans/`
